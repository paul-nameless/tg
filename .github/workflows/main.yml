name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]

    steps:

    - uses: actions/checkout@v2

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install tools
      run: |
        pip install poetry && poetry config virtualenvs.create false && poetry install --no-interaction --no-ansi

    - name: Check formatting and run linters
      run: |
        sh check.sh

    - name: build and deploy master image to ghcr.io
      # if: ${{ github.ref == 'refs/heads/master' }}
      env:
        GITHUB_PACKAGE_TOKEN: ${{ secrets.PKG_TOKEN }}
        USERNAME: ${{ github.actor }}
        GITHUB_REF: ${{ github.ref }}
      run: |
        ref="$(echo ${GITHUB_REF} | cut -d'/' -f3)"
        echo GITHUB_REF - $ref
        echo ${GITHUB_PACKAGE_TOKEN} | docker login ghcr.io -u ${USERNAME} --password-stdin
        docker build --push -t ghcr.io/${USERNAME}/tg:${ref} ghcr.io/${USERNAME}/tg:latest
